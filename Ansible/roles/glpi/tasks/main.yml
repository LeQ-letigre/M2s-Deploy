- name: Installer les dépendances pour Docker
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
    state: present
    update_cache: yes

- name: Ajouter la clé GPG officielle de Docker
  ansible.builtin.apt_key:
    url: https://download.docker.com/linux/debian/gpg
    state: present
    validate_certs: false

- name: Ajouter le repository Docker
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64] https://download.docker.com/linux/debian bookworm stable"
    state: present
    validate_certs: false


- name: Installer Docker Engine et le plugin Compose
  ansible.builtin.apt:
    name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-compose-plugin
    state: present
    update_cache: yes

- name: S'assurer que le service Docker est démarré
  ansible.builtin.systemd:
    name: docker
    state: started
    enabled: yes

- name: Créer les dossiers pour les volumes Docker
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "root"
    group: "root"
    mode: "0755"
  loop:
    - /opt/glpi/db_data
    - /opt/glpi/html

- name: Créer le réseau Docker pour GLPI
  community.docker.docker_network:
    name: glpi_net
    driver: bridge

- name: Lancer MariaDB pour GLPI 
  community.docker.docker_container:
    name: glpi_db 
    image: mariadb:{{ mariadb_version }}
    state: started
    restart_policy: always
    env:
      MYSQL_ROOT_PASSWORD: "root"
      MYSQL_DATABASE: "glpi"
      MYSQL_USER: "glpi"
      MYSQL_PASSWORD: "glpi"
    volumes:
      - /opt/glpi/db_data:/var/lib/mysql
    networks:
      - name: glpi_net

- name: Lancer GLPI (web)
  community.docker.docker_container:
    name: glpi_web
    image: diouxx/glpi
    state: started
    restart_policy: always
    ports:
      - "80:80"
    volumes:
      - /opt/glpi/html:/var/www/html
    env:
      TIMEZONE: Europe/Paris
    networks:
      - name: glpi_net

- name: Supprimer le fichier install.php de GLPI
  file:
    path: /opt/glpi/html/install/install.php
    state: absent

- name: Copier le dump SQL dans la VM GLPI
  copy:
    src: files/glpi.sql
    dest: /opt/glpi/glpi.sql

- name: Injecter la base GLPI via docker exec
  ansible.builtin.shell: |
    docker exec -i glpi_db mysql -u glpi -pglpi glpi < /opt/glpi/glpi.sql


